import pyarrow
import pyarrow.parquet as pq

import json
import pandas as pd

import uuid

from pathlib import Path


class SaveJson:


    def save_as_parquet(data, path=None):
        """
        Save the data as a Parquet file.
        """
        # pd.set_option('display.width', None)

        if isinstance(data, list) and isinstance(data[0], dict):
            data = pd.json_normalize(data)
        
        if path is None:
            path = (Path(__file__) / "./../../../").resolve()
            data_folder_path = path.joinpath(f'parquet_data/data/{uuid.uuid4()}.parquet')
        else: 
            data_folder_path = path

            
        table = pyarrow.Table.from_pandas(data)
        pq.write_table(table, data_folder_path)


if __name__ == "__main__":
    # Example usage
    data = [{'device': {'type': 'desktop', 'os': 'Windows', 'os_version': '12.006548746218897', 'app_version': '4.2.3', 'model': 'HP Spectre'}, 'location': {'country': 'Canada', 'city': 'Dorval', 'region': 'CA', 'timezone': 'America/Toronto'}, 'content': {'id': 'ba079a6b-ee44-4d0c-83bd-dcc31c00de8c', 'title': 'Road: Camelot', 'type': 'Reality Show', 'episode': 5, 'season': 2, 'provider': 'Peacock', 'genre': 'Action', 'release_year': 2001, 'duration': 26, 'language': 'en'}, 'event_type': 'content_play', 'user_subscription': {'plan': 'Standard', 'start_date': '2002-3-12', 'billing_cycle': 'yearly', 'connected_services': ['Netflix', 'Disney+', 'Hulu', 'HBO Max']}, 'timestamp': '39-11-14T4:1:42', 'event_details': {'play_duration': 923, 'play_percentage': 17.174331866463778, 'playback_quality': '4K', 'buffering_incidents': 4, 'playback_speed': 0.5586732471821692, 'paused': False, 'completed': True, 'network_type': 'Mobile', 'bandwidth': '78mbps'}, 'user_action': [{'action_type': 'playback_speed', 'timestamp': '2024-09-14T17:18:14', 'duration': None, 'old_speed': 1.8428283537993972, 'new_speed': 1.6437771514549018, 'old_quality': None, 'new_quality': None, 'completed': None}, {'action_type': 'pause', 'timestamp': '2021-12-09T23:04:05', 'duration': 365, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': None}], 'recommendations': [{'content_id': 'm148701', 'position': 1, 'algorithm': 'content_based', 'clicked': True}], 'search_history': [{'search_id': 's126843', 'timestamp': '2006-11-27T5:36:49', 'query': 'nebula', 'results_count': 34}, {'search_id': 's477246', 'timestamp': '2023-10-26T9:41:37', 'query': 'quantum', 'results_count': 76}]}, {'device': {'type': 'tablet', 'os': 'Android', 'os_version': '18.371769428550937', 'app_version': '5.2.0', 'model': 'Pixel 5'}, 'location': {'country': 'Italy', 'city': 'Campobasso', 'region': 'IT', 'timezone': 'Europe/Rome'}, 'content': {'id': '0d951bba-8396-422c-8275-47928b1281a8', 'title': 'Modern Oceans', 'type': 'TV Show', 'episode': 4, 'season': 11, 'provider': 'Apple TV+', 'genre': 'Adventure', 'release_year': 2009, 'duration': 34, 'language': 'es'}, 'event_type': 'search', 'user_subscription': {'plan': 'Basic', 'start_date': '2002-2-10', 'billing_cycle': 'yearly', 'connected_services': ['Disney+', 'Netflix']}, 'timestamp': '549-3-14T3:54:48', 'event_details': {'play_duration': 624, 'play_percentage': 83.31078234704763, 'playback_quality': 'SD', 'buffering_incidents': 5, 'playback_speed': 0.8294869748948599, 'paused': False, 'completed': True, 'network_type': 'WiFi', 'bandwidth': '44gbps'}, 'user_action': [{'action_type': 'playback_speed', 'timestamp': '2007-03-06T01:00:06', 'duration': None, 'old_speed': 1.8828091412064687, 'new_speed': 0.878633240784666, 'old_quality': None, 'new_quality': None, 'completed': None}, {'action_type': 'change quality', 'timestamp': '2021-12-18T15:20:00', 'duration': None, 'old_speed': None, 'new_speed': None, 'old_quality': 'SD', 'new_quality': '4K', 'completed': None}, {'action_type': 'pause', 'timestamp': '2024-04-10T22:11:28', 'duration': 425, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': None}], 'recommendations': [{'content_id': 'm443886', 'position': 1, 'algorithm': 'collaborative', 'clicked': False}, {'content_id': 'm177336', 'position': 2, 'algorithm': 'collaborative', 'clicked': True}, {'content_id': 'm560065', 'position': 3, 'algorithm': 'content_based', 'clicked': False}], 'search_history': [{'search_id': 's848283', 'timestamp': '2019-3-25T17:56:7', 'query': 'galaxy', 'results_count': 89}, {'search_id': 's958287', 'timestamp': '2016-4-2T0:56:42', 'query': 'photon', 'results_count': 88}, {'search_id': 's270823', 'timestamp': '2002-1-4T4:7:11', 'query': 'nebula', 'results_count': 49}, {'search_id': 's907973', 'timestamp': '2003-8-28T19:11:31', 'query': 'nebula', 'results_count': 16}]}, {'device': {'type': 'mobile', 'os': 'Android', 'os_version': '18.06881286223479', 'app_version': '4.1.2', 'model': 'OnePlus 9'}, 'location': {'country': 'France', 'city': 'Herblay', 'region': 'FR', 'timezone': 'Europe/Paris'}, 'content': {'id': 'e917af35-450f-4d74-aa9f-c2861c9947cb', 'title': 'The Myth of Light', 'type': 'Movie', 'episode': -1, 'season': -1, 'provider': 'Vimeo', 'genre': 'Animation', 'release_year': 2013, 'duration': 104, 'language': 'fr'}, 'event_type': 'browse', 'user_subscription': {'plan': 'Basic', 'start_date': '2002-4-16', 'billing_cycle': 'yearly', 'connected_services': ['Disney+', 'HBO Max', 'Amazon Prime', 'Netflix', 'Hulu']}, 'timestamp': '927-4-23T10:49:15', 'event_details': {'play_duration': 164, 'play_percentage': 63.77583851196385, 'playback_quality': 'SD', 'buffering_incidents': 1, 'playback_speed': 0.7475622052360539, 'paused': False, 'completed': False, 'network_type': 'Mobile', 'bandwidth': '64gbps'}, 'user_action': [{'action_type': 'playback_speed', 'timestamp': '2000-10-17T01:31:38', 'duration': None, 'old_speed': 1.345924262662181, 'new_speed': 1.6383146936316584, 'old_quality': None, 'new_quality': None, 'completed': None}, {'action_type': 'completed', 'timestamp': '2015-07-11T12:52:46', 'duration': 735, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': True}, {'action_type': 'completed', 'timestamp': '2013-11-01T12:49:23', 'duration': 980, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': True}, {'action_type': 'playback_speed', 'timestamp': '2010-06-11T00:00:34', 'duration': None, 'old_speed': 1.0038303165156526, 'new_speed': 0.9381489978065621, 'old_quality': None, 'new_quality': None, 'completed': None}, {'action_type': 'completed', 'timestamp': '2004-08-18T00:45:47', 'duration': 497, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': True}], 'recommendations': [{'content_id': 'm567621', 'position': 1, 'algorithm': 'hybrid', 'clicked': False}, {'content_id': 'm131549', 'position': 2, 'algorithm': 'hybrid', 'clicked': False}, {'content_id': 'm151747', 'position': 3, 'algorithm': 'collaborative', 'clicked': False}], 'search_history': [{'search_id': 's973961', 'timestamp': '2023-2-9T0:24:47', 'query': 'photon', 'results_count': 18}, {'search_id': 's533328', 'timestamp': '2001-5-15T17:40:29', 'query': 'quantum', 'results_count': 64}, {'search_id': 's189387', 'timestamp': '2002-5-20T15:54:43', 'query': 'photon', 'results_count': 31}, {'search_id': 's563380', 'timestamp': '2020-8-27T5:51:52', 'query': 'quantum', 'results_count': 48}]}, {'device': {'type': 'tablet', 'os': 'iOS', 'os_version': '11.30578620315877', 'app_version': '4.4.3', 'model': 'iPhone 12'}, 'location': {'country': 'Australia', 'city': 'Maryborough', 'region': 'AU', 'timezone': 'Australia/Brisbane'}, 'content': {'id': '5c0df876-9eee-4b09-92f4-acd1bd46eadc', 'title': "Atlantis's Castle", 'type': 'Animation', 'episode': -1, 'season': -1, 'provider': 'Peacock', 'genre': 'Science Fiction', 'release_year': 2015, 'duration': 109, 'language': 'en'}, 'event_type': 'browse', 'user_subscription': {'plan': 'Basic', 'start_date': '2006-5-4', 'billing_cycle': 'yearly', 'connected_services': ['Amazon Prime', 'Disney+', 'Netflix', 'HBO Max']}, 'timestamp': '493-5-20T7:16:5', 'event_details': {'play_duration': 355, 'play_percentage': 59.01766727043311, 'playback_quality': '4K', 'buffering_incidents': 4, 'playback_speed': 0.5200963789653646, 'paused': True, 'completed': True, 'network_type': 'WiFi', 'bandwidth': '73mbps'}, 'user_action': [{'action_type': 'playback_speed', 'timestamp': '2015-06-21T00:40:55', 'duration': None, 'old_speed': 1.356773622507446, 'new_speed': 1.4106546720037523, 'old_quality': None, 'new_quality': None, 'completed': None}, {'action_type': 'pause', 'timestamp': '2012-07-03T02:55:37', 'duration': 732, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': None}], 'recommendations': [{'content_id': 'm571887', 'position': 1, 'algorithm': 'collaborative', 'clicked': False}, {'content_id': 'm299869', 'position': 2, 'algorithm': 'hybrid', 'clicked': False}], 'search_history': [{'search_id': 's820705', 'timestamp': '2013-10-9T8:8:36', 'query': 'nebula', 'results_count': 35}, {'search_id': 's791058', 'timestamp': '2008-1-15T17:44:2', 'query': 'nebula', 'results_count': 24}, {'search_id': 's592018', 'timestamp': '2002-5-7T3:44:16', 'query': 'cosmos', 'results_count': 96}, {'search_id': 's734682', 'timestamp': '2023-12-17T5:56:26', 'query': 'quantum', 'results_count': 72}]}, {'device': {'type': 'desktop', 'os': 'Windows', 'os_version': '10.482042934240326', 'app_version': '2.0.2', 'model': 'HP Spectre'}, 'location': {'country': 'Canada', 'city': 'Kelowna', 'region': 'CA', 'timezone': 'America/Vancouver'}, 'content': {'id': 'a2df62a0-5719-4ffd-bd59-9fb4d207e4e8', 'title': 'Find the King', 'type': 'Documentary', 'episode': -1, 'season': -1, 'provider': 'HBO Max', 'genre': 'Animation', 'release_year': 2008, 'duration': 88, 'language': 'en'}, 'event_type': 'search', 'user_subscription': {'plan': 'Premium', 'start_date': '2020-8-21', 'billing_cycle': 'yearly', 'connected_services': ['Amazon Prime', 'Netflix']}, 'timestamp': '467-7-16T9:24:54', 'event_details': {'play_duration': 412, 'play_percentage': 66.32552478295007, 'playback_quality': 'SD', 'buffering_incidents': 3, 'playback_speed': 1.4858632747279694, 'paused': False, 'completed': True, 'network_type': 'Ethernet', 'bandwidth': '99mbps'}, 'user_action': [{'action_type': 'completed', 'timestamp': '2012-04-23T01:38:49', 'duration': 964, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': True}, {'action_type': 'completed', 'timestamp': '2010-09-27T20:23:20', 'duration': 713, 'old_speed': None, 'new_speed': None, 'old_quality': None, 'new_quality': None, 'completed': True}], 'recommendations': [{'content_id': 'm904258', 'position': 1, 'algorithm': 'content_based', 'clicked': False}, {'content_id': 'm107561', 'position': 2, 'algorithm': 'hybrid', 'clicked': False}], 'search_history': [{'search_id': 's472724', 'timestamp': '2008-8-2T15:20:27', 'query': 'galaxy', 'results_count': 44}, {'search_id': 's875062', 'timestamp': '2015-4-11T23:13:59', 'query': 'galaxy', 'results_count': 72}]}]

    print(type(data[0]))

    df = pd.json_normalize(data)
    SaveJson().save_as_parquet(df)